---
title: "チームでのPull Requestで心掛けていること"
emoji: "🔖"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: [github]
published: false
---

<!-- TODO: アドカレ挨拶 -->

業務でPull Requestを出す際に気をつけていたり実施していることがいくらかあり、せっかくなのでテキストに書き起こしてまとめてみます。

前提として、社内でGitHubを使っており、数人程度のチームでwebサービスを継続的に開発している環境を想定しています。
またPull Requestの変更内容や目的の良し悪しの話題（その変更は必要なのか？目的に沿っているか？など）については本記事の対象外とします。

:::message
サービスの性質や運用フロー、メンバーのスキル・性格などによって、アイデアの良し悪しは大きく変化しますのでご了承ください。
:::



## タイトル
タイトルは普通にやったことを書きますが、「見る人にとって過不足なく識別できる情報量」を入れるようにします。
だいたいサラッと一文、感覚的には助詞が1~2個に収まる程度。

ここで長くなりすぎるようであれば、本文にだけあれば良い情報が含まれているか、1 Pull Request内でやっている内容が多すぎる（分割すべき）というサインかなと思っています。

また内容以外では、特定の順番でレビューしてほしい場合にそれとわかるような情報を入れると親切です。

例えば目的の変更の前にリファクタしたPull Requestが別途ある場合、「XXXの変更のための事前リファクタ」と「XXXの変更」とすると、リストで見たときに「前者から見れば良さそうだな」と判断できます。連番の番号を入れることもあります。

他にも公開サイトに特有な要素として「本番環境への影響有無が誤解されないようにする」ことに気をつけます。

通常の機能リリースの他に、ドキュメントやテストのみの変更で影響が発生し得ないもの、リファクタで挙動は変えないが影響の可能性はゼロではないもの、機能実装したが参照を切っていてユーザに見えないものなどがあります。

タイトルではなく本文に入れても良いのですが、タイトルにある方がPull Requestリストや通知などを見たときにわかりやすく、また不要な驚き（「これ今リリースしないんじゃないの！？」など）が無くせて良いと思います。

※筆者のチームではPull Requestタイトルがリリース時にslack通知される運用になっており、非エンジニアメンバーも見る前提があるために重要度が高めです



## 本文
:::message
本文のフォーマットはチームでなんらか決まっていることが多いかとは思いますが、ルールがあればそれに従うのが大前提です。
:::

本文は変更の目的や設計意図など、コードでは語られない情報を置くのがベースかと思います。また関連issueや、mainでないbaseブランチがあればそのPull Requestなど、関連情報を辿れる情報も添えます。

また実装したものの意図だけでなく、検討したがやらなかったことも記しておきます。特に最終的な実装が素直なものでない場合はその理由が記されてないと、レビュアーに「なぜ素直なXXXの方法を採らなかったんだろう」と不要に悩ませてしまいます。



## Draftで作る
Pull Requestを作成する際には**まずDraftで**作成します。
公開してレビュー依頼をする前に、セルフレビューを実施しながらpullreq本文やコードの修正をするためです（詳細は後述）。

他にも、Ready for reviewの状態でCIが落ちたり検証でバグが見つかったりすると、レビュアーにバグのあるコードを見せてしまうことになります。直すことが確定しているコードを見せるのは時間の無駄です。

また、一度もReady for reviewしていなければ、commit書き換えやrebaseによるforce pushも問題無いです。むしろリリース頻度によってはReady for review直前にrebaseしたほうがconflictなどのリスクが下がることもあります。

逆に言えば、Ready for reviewしたのであればforce pushは**絶対に避けます**。レビュアーのレビュー状況やコメントresolvedなどのステータスが全部消えます。最終的なコード差分が同じであろうが絶対に避けます。
本当に必要であれば一旦draftにするなりして断りを入れます。



## セルフレビュー
レビュアーに見てもらう前に、まずはセルフレビューをします。

やることや目的としてはざっくりと
* やったこと全体を再確認する
* 意図せぬミスや差分が入り込んでいないかチェックする
* 改善の余地や説明不足が無いかをレビュアー視点で確認する
* レビュー負荷が下がるように調整を行う

などとなります。
特にレビュアー負荷の軽減はレビュアーの人数の分だけ効いてくるため、多少手間でもトータルでは効率化に繋がることが多く、積極的に実施します。

:::message
詳細については語りたいことは色々とありますが、1記事中の1セクションの中に記すには余白が狭すぎるので[別記事]()にしました。こちらも併せてご覧ください。
:::

セルフレビューがしっかりとできてから、Ready for reviewしてレビューを待ちます。



## レビュー対応
特筆すべきコメントの無い一発Approveでない限りは質問への回答やコードの修正を行いますが、実際にリアクションをする前にちょっと考えます。

パッと一言で回答できるような質問が来た場合、「そもそもその質問が発生しないようにできなかったか」と考えます。
質問が発生したということはPull Requestに疑問の余地があったわけで、セルフレビュー時点で発見・対処できたかもしれません。もちろん深い議論はするのが良いですが、シンプルな質疑は減らせることが多く、次以降の改善点とします。
※「質問」としていますが「意見」でもだいたい同じです

またRequest changeであっても、その修正が必要だと思った理由をより深ぼることで更に良いコードにできる可能性があります。実例として
* 元コードに、ファイル内に同じ正規表現マッチをする処理が二箇所あった
* 「正規表現パターンを定数に切り出しては？」と指摘があった

場合に、パターンだけでなく、マッチ処理とその後の変換コードをまるごと関数に切り出したことがありました。「そのパターン、DRYにできるよね」という指摘を「そのマッチ周りの処理、DRYにできるよね」としたかたちです。

<!-- TODO: 発掘できたら実際のコードに近いものを貼るなり文章を近づけるなり -->

ただし、こちらは方向性を間違えると「そういうことではないのだが...」となりかねないので、ちょうどよい塩梅を探る必要はあります。

## まとめ
なんとなくそれっぽくできてしまうPull Requestの一生ですが、それぞれの部分で結構考えられることはあると思っています。

本記事はかなり個人的な考えではありますが、日々やっている開発の中で参考にできることがあれば幸いです。
